---
sidebar_position: 2
sidebar_label: å‡Œæ™¨5ç‚¹è‡ªåŠ¨éƒ¨ç½²è„šæœ¬
title: å‡Œæ™¨5ç‚¹è‡ªåŠ¨éƒ¨ç½²è„šæœ¬
description: è¿™æ®µ Bash è„šæœ¬æ•´ä½“ä¸Šå†™å¾—éå¸¸è§„èŒƒã€æ¸…æ™°ã€å¥å£®ï¼Œå·²ç»è¿œè¶…ä¸€èˆ¬è¿ç»´è„šæœ¬çš„æ°´å¹³ï¼Œå…·å¤‡äº†ç”Ÿäº§çº§è‡ªåŠ¨åŒ–éƒ¨ç½²å·¥å…·çš„åŸºæœ¬ç´ è´¨ã€‚
keywords: [ä»£ç , è‡ªåŠ¨éƒ¨ç½²è„šæœ¬, è‹¥å–„äº‘]
---

# 5AMè‡ªåŠ¨éƒ¨ç½²è„šæœ¬

> æœ€åæ›´æ–°äº2025å¹´8æœˆ28å·



## ä¸€ã€é¡¹ç›®ç»“æ„

### 1ã€åç«¯è„šæœ¬è·¯å¾„ï¼ˆdeploy-project.shï¼‰

```JavaScript showLineNumbers=true
/home/build/ruo-shan-cloud
```

### 2ã€å‰ç«¯è„šæœ¬è·¯å¾„ï¼ˆcopyweb.shï¼‰

```JavaScript showLineNumbers=true
/home/build/ruo-shan-cloud-admin
```



## äºŒã€è‡ªåŠ¨åŒ–å‡Œæ™¨5ç‚¹éƒ¨ç½²

### auto-deploy.sh ä¸»ç¨‹åºè„šæœ¬

```Shell showLineNumbers=true
#!/usr/bin/env bash
set -euo pipefail

# ========================
# è‡ªåŠ¨éƒ¨ç½²è„šæœ¬ (åç«¯+å‰ç«¯)
# ========================

CONFIG_FILE="/home/build/deploy-config.conf"
LOG_DIR="/home/build/deploy-logs"
mkdir -p "$LOG_DIR" || {
    echo "âŒ é”™è¯¯: æ— æ³•åˆ›å»ºæ—¥å¿—ç›®å½• $LOG_DIRï¼Œè¯·æ£€æŸ¥æƒé™ï¼" >&2
    exit 1
}

TODAY=$(date +"%Y-%m-%d")
TIME_NOW=$(date +"%H%M%S")

# -------------------------
# å®‰å…¨åŠ è½½é…ç½®æ–‡ä»¶ï¼ˆé¿å… source æ³¨å…¥é£é™©ï¼‰
# -------------------------
if [ ! -f "$CONFIG_FILE" ]; then
    echo "âŒ é…ç½®æ–‡ä»¶ $CONFIG_FILE ä¸å­˜åœ¨ï¼Œé€€å‡ºï¼" >&2
    exit 1
fi

# === é»˜è®¤é…ç½®ï¼ˆé˜²æ­¢é…ç½®æ–‡ä»¶ç¼ºå¤±å…³é”®å­—æ®µï¼‰===
# è¿™äº›å€¼ä¼šè¢« deploy-config.conf è¦†ç›–ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
# é»˜è®¤è¡Œä¸ºï¼šæ‰§è¡Œéƒ¨ç½²ã€ç›®æ ‡æµ‹è¯•æœåŠ¡å™¨ã€ä»…éƒ¨ç½²åç«¯
RUN_DEPLOY="true"
DEPLOY_ENV="dev"
DEPLOY_SCOPE="backend"
# ==============================================

# é€è¡Œè§£æ key=value æ ¼å¼ï¼Œè·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
while IFS='=' read -r key value; do
    # å»é™¤å‰åç©ºæ ¼
    key=$(echo "$key" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
    value=$(echo "$value" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

    # è·³è¿‡ç©ºè¡Œæˆ–æ³¨é‡Š
    [[ -z "$key" || "$key" =~ ^# ]] && continue

    case "$key" in
        RUN_DEPLOY)   RUN_DEPLOY="$value"   ;;
        DEPLOY_ENV)   DEPLOY_ENV="$value"   ;;
        DEPLOY_SCOPE) DEPLOY_SCOPE="$value" ;;
    esac
done < "$CONFIG_FILE"

# --- ğŸ”’ å¼ºåˆ¶æ ¡éªŒ DEPLOY_SCOPE ---
case "$DEPLOY_SCOPE" in
    all|backend|frontend) ;;
    *)
        echo "âŒ é”™è¯¯: DEPLOY_SCOPE å¿…é¡»æ˜¯ all/backend/frontendï¼Œå½“å‰å€¼='$DEPLOY_SCOPE'" >&2
        exit 1
        ;;
esac

# --- âœ… ç”Ÿæˆæ—¥å¿—æ–‡ä»¶å ---
LOG_FILE="$LOG_DIR/deploy_${TODAY}_${DEPLOY_SCOPE}_${TIME_NOW}.log"

# --- ğŸ›¡ï¸ å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿ LOG_FILE å¯å†™ ---
if ! touch "$LOG_FILE".tmp 2>/dev/null; then
    echo "âŒ é”™è¯¯: æ— æ³•å†™å…¥æ—¥å¿—æ–‡ä»¶ $LOG_FILEï¼Œè¯·æ£€æŸ¥ç›®å½•æƒé™ï¼" >&2
    exit 1
fi
rm -f "$LOG_FILE".tmp

# --- ğŸ“ æ—¥å¿—å‡½æ•°ï¼šå†™å…¥å¸¦æ—¶é—´æˆ³çš„æ—¥å¿— ---
log() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] $1" | tee -a "$LOG_FILE"
}

# --- ğŸ¨ å½©è‰²æ§åˆ¶å°è¾“å‡º ---
console_log() {
    echo -e "$1"
}

# --- ğŸ•°ï¸ è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤© 5:00 æ‰§è¡Œï¼‰ ---
CRON_JOB="0 5 * * * /bin/bash /home/build/auto-deploy.sh run"

if crontab -l 2>/dev/null | grep -Fxq "$CRON_JOB"; then
    log "å®šæ—¶ä»»åŠ¡å·²å­˜åœ¨ï¼Œæ— éœ€é‡å¤å†™å…¥ã€‚"
else
    (crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -
    log "å·²å°†å®šæ—¶ä»»åŠ¡å†™å…¥ crontabï¼š$CRON_JOB"
fi

# --- ğŸšª å¦‚æœæ²¡æœ‰ run å‚æ•°ï¼Œåªå†™å®šæ—¶ä»»åŠ¡ ---
if [ "${1:-}" != "run" ]; then
    log "é¦–æ¬¡æ‰§è¡Œï¼Œä»…å†™å…¥å®šæ—¶ä»»åŠ¡ï¼Œä¸ç«‹åˆ»è¿è¡Œéƒ¨ç½²ã€‚"
    exit 0
fi

# -------------------------
# å¼€å§‹éƒ¨ç½²é€»è¾‘
# -------------------------
log "======== éƒ¨ç½²ä»»åŠ¡å¯åŠ¨ ========"

LOCK_FILE="/home/build/.auto-deploy.lock"

# æ£€æŸ¥é”æ–‡ä»¶å¹¶åˆ¤æ–­åŸè¿›ç¨‹æ˜¯å¦ä»åœ¨è¿è¡Œ
if [ -f "$LOCK_FILE" ]; then
    LOCK_PID=$(cat "$LOCK_FILE" 2>/dev/null || true)
    if [[ -n "$LOCK_PID" ]] && kill -0 "$LOCK_PID" 2>/dev/null; then
        log "æ£€æµ‹åˆ°æ­£åœ¨è¿è¡Œçš„éƒ¨ç½²è¿›ç¨‹ (PID: $LOCK_PID)ï¼Œé€€å‡ºä»¥é¿å…å†²çªã€‚"
        exit 1
    else
        log "å‘ç°è¿‡æœŸé”æ–‡ä»¶ï¼ˆPID $LOCK_PID å·²ä¸å­˜åœ¨ï¼‰ï¼Œæ¸…é™¤å¹¶ç»§ç»­ã€‚"
        rm -f "$LOCK_FILE"
    fi
fi

# åˆ›å»ºé”æ–‡ä»¶
echo "$$" > "$LOCK_FILE"
trap 'rm -f "$LOCK_FILE"; log "éƒ¨ç½²ä»»åŠ¡ç»“æŸã€‚"' EXIT

START_TIME=$(date +%s)

# -------------------------
# é…ç½®æ ¡éªŒä¸ç¯å¢ƒè®¾ç½®
# -------------------------
log "åŠ è½½é…ç½®æ–‡ä»¶: $CONFIG_FILE"
log "é…ç½®å‚æ•°: RUN_DEPLOY=$RUN_DEPLOY, DEPLOY_ENV=$DEPLOY_ENV, DEPLOY_SCOPE=$DEPLOY_SCOPE"

if [ "$RUN_DEPLOY" != "true" ]; then
    log "é…ç½®ä¸­è®¾ç½®äº† RUN_DEPLOY=falseï¼Œä»Šå¤©ä¸æ‰§è¡Œéƒ¨ç½²ï¼Œé€€å‡ºã€‚"
    exit 0
fi

# è®¾ç½®åç«¯å‘½ä»¤ï¼ˆä½¿ç”¨æ•°ç»„å®‰å…¨æ‰§è¡Œï¼‰
case "${DEPLOY_ENV:-dev}" in
    dev)
        BACKEND_CMD=(./deploy-project.sh -d -p -b)
        ENV_NAME="æµ‹è¯•æœåŠ¡å™¨"
        ;;
    prod)
        BACKEND_CMD=(./deploy-project.sh -p -b)
        ENV_NAME="æ­£å¼æœåŠ¡å™¨"
        ;;
    *)
        log "é”™è¯¯: DEPLOY_ENV å¿…é¡»æ˜¯ 'dev' æˆ– 'prod'ï¼Œå½“å‰å€¼=$DEPLOY_ENV"
        exit 1
        ;;
esac

log "ç›®æ ‡ç¯å¢ƒ: $ENV_NAME"
log "åç«¯éƒ¨ç½²å‘½ä»¤: ${BACKEND_CMD[*]}"

# -------------------------
# åˆå§‹åŒ–éƒ¨ç½²ç»“æœå˜é‡ï¼ˆå…³é”®ï¼ï¼‰
# -------------------------
BACKEND_EXIT=0
FRONTEND_EXIT=0

# -------------------------
# åç«¯éƒ¨ç½²ï¼ˆå¦‚æœéœ€è¦ï¼‰
# -------------------------
if [ "$DEPLOY_SCOPE" = "all" ] || [ "$DEPLOY_SCOPE" = "backend" ]; then
    if [ ! -d "/home/build/ruo-shan-cloud" ]; then
        log "é”™è¯¯: æ‰¾ä¸åˆ°åç«¯é¡¹ç›®ç›®å½• /home/build/ruo-shan-cloud"
        BACKEND_EXIT=1
    else
        cd /home/build/ruo-shan-cloud || {
            log "é”™è¯¯: æ— æ³•è¿›å…¥åç«¯ç›®å½• /home/build/ruo-shan-cloud"
            BACKEND_EXIT=1
        }

        if [ $BACKEND_EXIT -eq 0 ]; then
            log "è¿›å…¥åç«¯ç›®å½•: $(pwd)"

            console_log "\033[1;34mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m"
            console_log "\033[1;36mâœ… å¼€å§‹æ‰§è¡Œåç«¯éƒ¨ç½²\033[0m"
            log "å¼€å§‹æ‰§è¡Œåç«¯éƒ¨ç½²"
            console_log "\033[1;33må‘½ä»¤: '${BACKEND_CMD[*]}'\033[0m"
            log "æ‰§è¡Œå‘½ä»¤: ${BACKEND_CMD[*]}"
            console_log "\033[1;32mâ³ æç¤ºï¼šMaven æ„å»ºå¯èƒ½éœ€è¦ 2-5 åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…...\033[0m"
            console_log "\033[1;35mğŸ“ å®æ—¶æ—¥å¿—å·²åŒæ­¥è®°å½•åˆ°: $LOG_FILE\033[0m"
            console_log "\033[1;34mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m"

            # åˆ¤æ–­è„šæœ¬æ˜¯å¦å­˜åœ¨å¹¶é€‰æ‹©æ‰§è¡Œæ–¹å¼
            if [ -x "${BACKEND_CMD[0]}" ]; then
                cmd=("${BACKEND_CMD[@]}")
            elif [ -f "${BACKEND_CMD[0]}" ]; then
                log "æ³¨æ„: åç«¯éƒ¨ç½²è„šæœ¬å­˜åœ¨ä½†ä¸å¯æ‰§è¡Œï¼Œæ”¹ç”¨ 'bash' è¿è¡Œã€‚"
                cmd=(bash "${BACKEND_CMD[@]}")
            else
                log "é”™è¯¯: åç«¯éƒ¨ç½²è„šæœ¬ ${BACKEND_CMD[0]} ä¸å­˜åœ¨"
                BACKEND_EXIT=1
            fi

            if [ $BACKEND_EXIT -eq 0 ]; then
                "${cmd[@]}" 2>&1 | tee -a "$LOG_FILE"
                BACKEND_EXIT=${PIPESTATUS[0]}
            fi

            if [ $BACKEND_EXIT -ne 0 ]; then
                log "åç«¯éƒ¨ç½²å¤±è´¥ âŒ"
            else
                log "åç«¯éƒ¨ç½²æˆåŠŸ âœ…"
            fi
        fi
    fi
fi

# -------------------------
# å‰ç«¯éƒ¨ç½²ï¼ˆå¦‚æœéœ€è¦ï¼‰
# -------------------------
if [ "$DEPLOY_SCOPE" = "all" ] || [ "$DEPLOY_SCOPE" = "frontend" ]; then
    if [ ! -d "/home/build/ruo-shan-cloud-admin" ]; then
        log "é”™è¯¯: æ‰¾ä¸åˆ°å‰ç«¯é¡¹ç›®ç›®å½• /home/build/ruo-shan-cloud-admin"
        FRONTEND_EXIT=1
    else
        cd /home/build/ruo-shan-cloud-admin || {
            log "é”™è¯¯: æ— æ³•è¿›å…¥å‰ç«¯ç›®å½• /home/build/ruo-shan-cloud-admin"
            FRONTEND_EXIT=1
        }

        if [ $FRONTEND_EXIT -eq 0 ]; then
            log "è¿›å…¥å‰ç«¯ç›®å½•: $(pwd)"

            console_log "\033[1;34mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m"
            console_log "\033[1;36mâœ… å¼€å§‹æ‰§è¡Œå‰ç«¯éƒ¨ç½²\033[0m"
            log "å¼€å§‹æ‰§è¡Œå‰ç«¯éƒ¨ç½²"
            console_log "\033[1;33må‘½ä»¤: ./copyweb.sh\033[0m"
            log "æ‰§è¡Œå‘½ä»¤: ./copyweb.sh"
            console_log "\033[1;32mâ³ æç¤ºï¼šå‰ç«¯æ„å»ºï¼ˆvite buildï¼‰å¯èƒ½éœ€è¦ 1-3 åˆ†é’Ÿ...\033[0m"
            console_log "\033[1;35mğŸ“ å®æ—¶æ—¥å¿—å·²åŒæ­¥è®°å½•åˆ°: $LOG_FILE\033[0m"
            console_log "\033[1;34mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m"

            # åˆ¤æ–­è„šæœ¬æ˜¯å¦å­˜åœ¨å¹¶é€‰æ‹©æ‰§è¡Œæ–¹å¼
            if [ -x "./copyweb.sh" ]; then
                cmd=(./copyweb.sh)
            elif [ -f "./copyweb.sh" ]; then
                log "æ³¨æ„: å‰ç«¯éƒ¨ç½²è„šæœ¬å­˜åœ¨ä½†ä¸å¯æ‰§è¡Œï¼Œæ”¹ç”¨ 'bash' è¿è¡Œã€‚"
                cmd=(bash ./copyweb.sh)
            else
                log "é”™è¯¯: å‰ç«¯éƒ¨ç½²è„šæœ¬ ./copyweb.sh ä¸å­˜åœ¨"
                FRONTEND_EXIT=1
            fi

            if [ $FRONTEND_EXIT -eq 0 ]; then
                "${cmd[@]}" 2>&1 | tee -a "$LOG_FILE"
                FRONTEND_EXIT=${PIPESTATUS[0]}
            fi

            if [ $FRONTEND_EXIT -ne 0 ]; then
                log "å‰ç«¯éƒ¨ç½²å¤±è´¥ âŒ"
            else
                log "å‰ç«¯éƒ¨ç½²æˆåŠŸ âœ…"
            fi
        fi
    fi
fi

# -------------------------
# éƒ¨ç½²å®Œæˆï¼Œè¾“å‡ºç»Ÿè®¡
# -------------------------
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))
HOURS=$((DURATION / 3600))
MINUTES=$(((DURATION % 3600) / 60))
SECONDS=$((DURATION % 60))

log "======== éƒ¨ç½²å®Œæˆ ($ENV_NAME) ========"
log "éƒ¨ç½²æ€»è€—æ—¶: ${HOURS}h ${MINUTES}m ${SECONDS}s"

# æç¤ºæŸ¥çœ‹æ—¥å¿—ï¼ˆæ§åˆ¶å°ä¸“å±ï¼‰
console_log "\033[1;35mğŸ“ æ—¥å¿—æ–‡ä»¶: $LOG_FILE\033[0m"
console_log "\033[1;33mğŸ’¡ æŸ¥çœ‹æ—¥å¿—: /home/build/check-log.sh ${DEPLOY_SCOPE}\033[0m"
console_log ""  # åŠ ä¸ªç©ºè¡Œï¼Œæå‡å¯è¯»æ€§

# -------------------------
# å‘é€éƒ¨ç½²å®Œæˆé€šçŸ¥ï¼ˆå¢å¼ºç‰ˆï¼‰
# -------------------------

# æƒ…å†µ1ï¼šå…¨é‡éƒ¨ç½²ï¼ˆallï¼‰â†’ å‘é€ç»Ÿä¸€é€šçŸ¥
if [ "$DEPLOY_SCOPE" = "all" ]; then
    if [ $BACKEND_EXIT -eq 0 ] && [ $FRONTEND_EXIT -eq 0 ]; then
        /home/build/send-notify.sh \
            "å…¨æ ˆéƒ¨ç½²æˆåŠŸ âœ…" \
            "ğŸ‰ åç«¯ + å‰ç«¯ éƒ¨ç½²å…¨éƒ¨å®Œæˆ\nç¯å¢ƒ: $ENV_NAME\nè€—æ—¶: ${HOURS}h ${MINUTES}m ${SECONDS}s\næ—¥å¿—: \`$LOG_FILE\`" \
            "success"
    else
        ERROR_MSG="âŒ å…¨æ ˆéƒ¨ç½²å¤±è´¥\n"
        [ $BACKEND_EXIT -ne 0 ] && ERROR_MSG+="â€¢ åç«¯éƒ¨ç½²å¤±è´¥\n"
        [ $FRONTEND_EXIT -ne 0 ] && ERROR_MSG+="â€¢ å‰ç«¯éƒ¨ç½²å¤±è´¥\n"
        ERROR_MSG+="æ—¥å¿—: \`$LOG_FILE\`"

        /home/build/send-notify.sh \
            "å…¨æ ˆéƒ¨ç½²å¤±è´¥ âŒ" \
            "$ERROR_MSG" \
            "error"
    fi

# æƒ…å†µ2ï¼šåªéƒ¨ç½²åç«¯
elif [ "$DEPLOY_SCOPE" = "backend" ]; then
    if [ $BACKEND_EXIT -eq 0 ]; then
        /home/build/send-notify.sh \
            "åç«¯éƒ¨ç½²æˆåŠŸ ğŸ‰" \
            "ç¯å¢ƒ: $ENV_NAME\nè€—æ—¶: ${HOURS}h ${MINUTES}m ${SECONDS}s\næ—¥å¿—: \`$LOG_FILE\`" \
            "success"
    else
        /home/build/send-notify.sh \
            "åç«¯éƒ¨ç½²å¤±è´¥ âŒ" \
            "ç¯å¢ƒ: $ENV_NAME\næ—¥å¿—: \`$LOG_FILE\`" \
            "error"
    fi

# æƒ…å†µ3ï¼šåªéƒ¨ç½²å‰ç«¯
elif [ "$DEPLOY_SCOPE" = "frontend" ]; then
    if [ $FRONTEND_EXIT -eq 0 ]; then
        /home/build/send-notify.sh \
            "å‰ç«¯éƒ¨ç½²æˆåŠŸ ğŸ‰" \
            "ç¯å¢ƒ: $ENV_NAME\nè€—æ—¶: ${HOURS}h ${MINUTES}m ${SECONDS}s\næ—¥å¿—: \`$LOG_FILE\`" \
            "success"
    else
        /home/build/send-notify.sh \
            "å‰ç«¯éƒ¨ç½²å¤±è´¥ âŒ" \
            "ç¯å¢ƒ: $ENV_NAME\næ—¥å¿—: \`$LOG_FILE\`" \
            "error"
    fi
fi

# -------------------------
# æœ€ç»ˆé€€å‡ºç 
# -------------------------
if [ $BACKEND_EXIT -ne 0 ] || [ $FRONTEND_EXIT -ne 0 ]; then
    exit 1
else
    exit 0
fi
```

è¿™æ®µ Bash è„šæœ¬æ•´ä½“ä¸Šå†™å¾—éå¸¸**è§„èŒƒã€æ¸…æ™°ã€å¥å£®**ï¼Œå·²ç»è¿œè¶…ä¸€èˆ¬è¿ç»´è„šæœ¬çš„æ°´å¹³ï¼Œå…·å¤‡äº†ç”Ÿäº§çº§è‡ªåŠ¨åŒ–éƒ¨ç½²å·¥å…·çš„åŸºæœ¬ç´ è´¨ã€‚ä¸‹é¢æˆ‘ä» **ä»£ç ç»“æ„ã€å®‰å…¨æ€§ã€å¥å£®æ€§ã€å¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§ã€æ½œåœ¨é£é™©ä¸æ”¹è¿›å»ºè®®** ç­‰å¤šä¸ªç»´åº¦è¿›è¡Œè¯¦ç»†åˆ†æã€‚

### âœ… ä¼˜ç‚¹æ€»ç»“ï¼ˆäº®ç‚¹ï¼‰

#### 1. **è‰¯å¥½çš„ç»“æ„è®¾è®¡**

- æ¨¡å—åŒ–æ¸…æ™°ï¼šæ—¥å¿—ã€é…ç½®åŠ è½½ã€é”æœºåˆ¶ã€éƒ¨ç½²é€»è¾‘ã€é€šçŸ¥ç­‰åˆ†å—æ˜ç¡®ã€‚
- ä½¿ç”¨å‡½æ•°å°è£…æ—¥å¿—è¾“å‡ºï¼ˆ`log` å’Œ `console_log`ï¼‰ï¼Œä¾¿äºç»Ÿä¸€ç®¡ç†ã€‚
- éƒ¨ç½²æµç¨‹é€»è¾‘æ¸…æ™°ï¼Œæœ‰é¡ºåºã€æœ‰åˆ†æ”¯åˆ¤æ–­ã€‚


#### 2. **å¼ºå¥çš„é”™è¯¯å¤„ç†å’Œé˜²æŠ¤æœºåˆ¶**

- `set -euo pipefail`ï¼šå¼€å¯ä¸¥æ ¼æ¨¡å¼ï¼Œé˜²æ­¢æœªå®šä¹‰å˜é‡ã€å‘½ä»¤å¤±è´¥å¿½ç•¥ç­‰é—®é¢˜ã€‚
- å¯¹å…³é”®ç›®å½•å’Œæ–‡ä»¶åšå­˜åœ¨æ€§æ£€æŸ¥ï¼ˆå¦‚æ—¥å¿—ç›®å½•ã€é…ç½®æ–‡ä»¶ã€é¡¹ç›®ç›®å½•ï¼‰ã€‚
- ä½¿ç”¨ `PIPESTATUS` è·å–ç®¡é“ä¸­å‘½ä»¤çš„çœŸå®é€€å‡ºç ï¼Œé¿å…å›  `tee` å¯¼è‡´è¯¯åˆ¤ã€‚
- é”æ–‡ä»¶æœºåˆ¶é˜²æ­¢å¹¶å‘æ‰§è¡Œï¼Œä¸”ä¼šæ£€æµ‹åŸè¿›ç¨‹æ˜¯å¦å­˜æ´»ï¼Œé¿å…â€œæ­»é”â€ã€‚
- `trap` æ¸…ç†é”æ–‡ä»¶ï¼Œç¡®ä¿å¼‚å¸¸é€€å‡ºä¹Ÿèƒ½é‡Šæ”¾èµ„æºã€‚


#### 3. **å®‰å…¨çš„é…ç½®åŠ è½½æ–¹å¼**

- æ²¡æœ‰ç›´æ¥ `source` é…ç½®æ–‡ä»¶ï¼ˆé¿å…æ³¨å…¥é£é™©ï¼‰ï¼Œè€Œæ˜¯é€è¡Œè§£æ `key=value`ï¼Œè·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œã€‚
- æ”¯æŒé»˜è®¤å€¼ + é…ç½®è¦†ç›–ï¼Œæé«˜äº†å®¹é”™èƒ½åŠ›ã€‚
- å¼ºåˆ¶æ ¡éªŒ `DEPLOY_SCOPE` å’Œ `DEPLOY_ENV` çš„åˆæ³•å€¼ï¼Œé˜²æ­¢éæ³•è¾“å…¥ã€‚


#### 4. **å®Œå–„çš„æ—¥å¿—ç³»ç»Ÿ**

- æ—¥å¿—å¸¦æ—¶é—´æˆ³ï¼Œæ ¼å¼ç»Ÿä¸€ã€‚
- å®æ—¶è¾“å‡ºåˆ°æ§åˆ¶å°å¹¶å†™å…¥æ–‡ä»¶ï¼ˆé€šè¿‡ `tee`ï¼‰ã€‚
- æ—¥å¿—è·¯å¾„å¯è¿½æº¯ï¼Œå‘½ååŒ…å«æ—¶é—´ã€ä½œç”¨åŸŸã€æ¯«ç§’çº§æ—¶é—´æˆ³ã€‚
- æç¤ºç”¨æˆ·å¦‚ä½•æŸ¥çœ‹æ—¥å¿—ï¼ˆ`check-log.sh`ï¼‰ã€‚


#### 5. **ç”¨æˆ·å‹å¥½çš„äº¤äº’ä½“éªŒ**

- ä½¿ç”¨ ANSI é¢œè‰²è¾“å‡ºï¼Œå…³é”®ä¿¡æ¯é«˜äº®ï¼ˆè“è‰²åˆ†éš”çº¿ã€ç»¿è‰²æˆåŠŸã€çº¢è‰²å¤±è´¥ï¼‰ã€‚
- ç»™å‡ºæ„å»ºè€—æ—¶é¢„ä¼°æç¤ºï¼ˆå¦‚ Maven æ„å»º 2-5 åˆ†é’Ÿï¼‰ï¼Œæå‡ç­‰å¾…ä½“éªŒã€‚
- æ§åˆ¶å°æç¤ºæŸ¥çœ‹æ—¥å¿—çš„æ–¹å¼ï¼Œé™ä½ä½¿ç”¨é—¨æ§›ã€‚


#### 6. **è‡ªåŠ¨åŒ–è°ƒåº¦æ”¯æŒ**

- è‡ªåŠ¨å†™å…¥ crontabï¼Œå®ç°å®šæ—¶éƒ¨ç½²ã€‚
- é¦–æ¬¡è¿è¡Œåªå†™å®šæ—¶ä»»åŠ¡ï¼Œé¿å…ç«‹å³æ‰§è¡Œé€ æˆæ··ä¹±ã€‚
- åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤æ·»åŠ ã€‚


#### 7. **çµæ´»çš„éƒ¨ç½²ç­–ç•¥**

- æ”¯æŒ `all` / `backend` / `frontend` å¤šç§éƒ¨ç½²èŒƒå›´ã€‚
- æ”¯æŒ `dev` / `prod` ç¯å¢ƒåˆ‡æ¢ï¼Œå‘½ä»¤ä¸åŒã€‚
- å¯é€šè¿‡é…ç½®æ§åˆ¶æ˜¯å¦æ‰§è¡Œï¼ˆ`RUN_DEPLOY=false` åˆ™è·³è¿‡ï¼‰ã€‚


#### 8. **é€šçŸ¥æœºåˆ¶å®Œå–„**

- æ ¹æ®ä¸åŒéƒ¨ç½²èŒƒå›´å’Œç»“æœå‘é€ä¸åŒé€šçŸ¥å†…å®¹ã€‚
- æˆåŠŸ/å¤±è´¥æ¶ˆæ¯åŒºåˆ†æ˜ç¡®ï¼ŒåŒ…å«ç¯å¢ƒã€è€—æ—¶ã€æ—¥å¿—è·¯å¾„ã€‚
- æ”¯æŒç»“æ„åŒ–é€šçŸ¥ï¼ˆæ ‡é¢˜ã€å†…å®¹ã€ç±»å‹ï¼‰ï¼Œæ–¹ä¾¿é›†æˆä¼ä¸šå¾®ä¿¡/é’‰é’‰ç­‰ã€‚


### âš ï¸ æ½œåœ¨é—®é¢˜ä¸æ”¹è¿›å»ºè®®

å°½ç®¡è„šæœ¬å·²ç»å¾ˆä¼˜ç§€ï¼Œä½†ä»æœ‰ä¸€äº›å¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ï¼š

#### ğŸ”§ 1. **`cmd`** **æ•°ç»„è¦†ç›–é—®é¢˜ï¼ˆæ½œåœ¨ bugï¼‰**

```Bash showLineNumbers=true
if [ -x "${BACKEND_CMD[0]}" ]; then
    cmd=("${BACKEND_CMD[@]}")
elif [ -f "${BACKEND_CMD[0]}" ]; then
    log "æ³¨æ„: åç«¯éƒ¨ç½²è„šæœ¬å­˜åœ¨ä½†ä¸å¯æ‰§è¡Œï¼Œæ”¹ç”¨ 'bash' è¿è¡Œã€‚"
    cmd=(bash "${BACKEND_CMD[@]}")
else
    log "é”™è¯¯: åç«¯éƒ¨ç½²è„šæœ¬ ${BACKEND_CMD[0]} ä¸å­˜åœ¨"
    BACKEND_EXIT=1
fi
```

#### âŒ é—®é¢˜ï¼š

`BACKEND_CMD` æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ˆå¦‚ `(./deploy-project.sh -d -p -b)`ï¼‰ï¼Œå½“ç”¨ `bash "${BACKEND_CMD[@]}"` æ‰§è¡Œæ—¶ï¼Œ**ç¬¬ä¸€ä¸ªå‚æ•° **`./deploy-project.sh`** ä¼šè¢«å½“ä½œè„šæœ¬åä¼ ç»™ bashï¼Œå…¶ä½™å‚æ•°æ­£ç¡®ä¼ é€’** â€”â€” è¿™æ˜¯æ­£ç¡®çš„ã€‚

ä½†æ³¨æ„ï¼š`BACKEND_CMD[0]` æ˜¯ `./deploy-project.sh`ï¼Œè€Œ `BACKEND_CMD[1..n]` æ˜¯å‚æ•°ã€‚ä¸Šé¢å†™æ³•æ²¡é—®é¢˜ã€‚

âœ… **ç»“è®ºï¼šæ­¤å¤„é€»è¾‘æ˜¯æ­£ç¡®çš„ï¼Œæ— éœ€ä¿®æ”¹ã€‚**

> âœ… å»ºè®®åŠ ä¸ªæ³¨é‡Šè¯´æ˜ï¼šâ€œä½¿ç”¨ bash æ‰§è¡Œéå¯æ‰§è¡Œè„šæœ¬ï¼Œä¿ç•™åŸå‚æ•°â€ã€‚

#### ğŸ”§ 2. **`cd`** **åæœªè¿”å›åŸè·¯å¾„ï¼ˆå½±å“åç»­æ“ä½œï¼‰**

```Bash showLineNumbers=true
cd /home/build/ruo-shan-cloud || { ... }
```

å¦‚æœåç»­è¿˜è¦è®¿é—®å…¶ä»–è·¯å¾„ï¼ˆè™½ç„¶ç›®å‰æ²¡æœ‰ï¼‰ï¼Œå½“å‰å·¥ä½œç›®å½•å·²å˜ï¼Œå¯èƒ½å½±å“åˆ¤æ–­ã€‚

âœ… å»ºè®®ï¼šä½¿ç”¨å­ shell æ‰§è¡Œ `cd`ï¼Œé¿å…æ±¡æŸ“ä¸»è¿›ç¨‹ç¯å¢ƒ

```Bash showLineNumbers=true
(
    cd /home/build/ruo-shan-cloud || {
        log "æ— æ³•è¿›å…¥åç«¯ç›®å½•"
        exit 1
    }
    # åœ¨å­ shell ä¸­æ‰§è¡Œéƒ¨ç½²å‘½ä»¤
    "${cmd[@]}" 2>&1 | tee -a "$LOG_FILE"
) 
BACKEND_EXIT=${PIPESTATUS[0]}
```

> âš ï¸ æ³¨æ„ï¼šè¿™æ ·å°±ä¸èƒ½ç”¨ `PIPESTATUS` äº†ï¼Œå› ä¸ºå­ shell ç»“æŸåçˆ¶ shell æ‹¿ä¸åˆ°å®ƒçš„ `PIPESTATUS`ã€‚

æ›´ä¼˜è§£ï¼šä½¿ç”¨ `pushd/popd`

```Bash showLineNumbers=true
pushd /home/build/ruo-shan-cloud > /dev/null || {
    log "æ— æ³•è¿›å…¥åç«¯ç›®å½•"
    FRONTEND_EXIT=1
    continue
}
# æ‰§è¡Œå‘½ä»¤
"${cmd[@]}" 2>&1 | tee -a "$LOG_FILE"
FRONTEND_EXIT=${PIPESTATUS[0]}
popd > /dev/null
```

âœ… æ¨èä½¿ç”¨ `pushd/popd` æ¥ä¿è¯è·¯å¾„åˆ‡æ¢å®‰å…¨ã€‚

#### ğŸ”§ 3. **æ—¥å¿—æ–‡ä»¶åä¸­æ—¶é—´ç²¾åº¦ä¸è¶³**

```Bash showLineNumbers=true
TIME_NOW=$(date +"%H%M%S")
```

å¦‚æœä¸€å¤©å†…å¤šæ¬¡éƒ¨ç½²ï¼Œæœ‰å¯èƒ½å‡ºç°æ—¥å¿—æ–‡ä»¶åå†²çªï¼ˆå°¤å…¶åœ¨ CI/CD é«˜é¢‘åœºæ™¯ï¼‰ã€‚

âœ… å»ºè®®ï¼šå¢åŠ æ¯«ç§’æˆ–çº³ç§’çº§æ—¶é—´æˆ³

```Bash showLineNumbers=true
TIME_NOW=$(date +"%H%M%S%3N")  # æ¯«ç§’
# æˆ–
TIME_NOW=$(date +"%s%3N")      # æ—¶é—´æˆ³+æ¯«ç§’
```

æˆ–è€…ç›´æ¥ç”¨ `$$`ï¼ˆPIDï¼‰é˜²é‡ï¼š

```Bash showLineNumbers=true
LOG_FILE="$LOG_DIR/deploy_${TODAY}_${DEPLOY_SCOPE}_${TIME_NOW}_$$"
```

#### ğŸ”§ 4. **`send-notify.sh`** **è·¯å¾„ç¡¬ç¼–ç ï¼Œç¼ºä¹å¥å£®æ€§**

```Bash showLineNumbers=true
/home/build/send-notify.sh
```

å¦‚æœè„šæœ¬è¢«ç§»åŠ¨æˆ–è·¯å¾„å˜æ›´ï¼Œé€šçŸ¥ä¼šå¤±è´¥ã€‚

âœ… å»ºè®®ï¼šå®šä¹‰å˜é‡æˆ–æ£€æŸ¥æ˜¯å¦å­˜åœ¨

```Bash showLineNumbers=true
NOTIFY_SCRIPT="/home/build/send-notify.sh"
if [ ! -x "$NOTIFY_SCRIPT" ]; then
    log "è­¦å‘Š: é€šçŸ¥è„šæœ¬ä¸å­˜åœ¨æˆ–ä¸å¯æ‰§è¡Œ: $NOTIFY_SCRIPT"
else
    "$NOTIFY_SCRIPT" "æ ‡é¢˜" "å†…å®¹" "type"
fi
```

#### ğŸ”§ 5. **ç¼ºå°‘éƒ¨ç½²å‰çš„ Git æ‹‰å–æˆ–ä»£ç æ›´æ–°é€»è¾‘**

å½“å‰è„šæœ¬å‡è®¾ä»£ç å·²å­˜åœ¨ä¸”æœ€æ–°ï¼Œä½†å®é™…éƒ¨ç½²å‰åº”ç¡®ä¿æ‹‰å–æœ€æ–°ä»£ç ã€‚

âœ… å»ºè®®å¢åŠ ï¼š

```Bash showLineNumbers=true
# åœ¨ cd åæ·»åŠ 
git fetch --all
git reset --hard origin/main  # æˆ–å…¶ä»–åˆ†æ”¯
git clean -fdx
```

âš ï¸ æ³¨æ„ï¼šè¿™éœ€è¦ç¡®è®¤åˆ†æ”¯ç­–ç•¥ã€æ˜¯å¦å…è®¸å¼ºåˆ¶è¦†ç›–ã€‚

#### ğŸ”§ 6. **ç¼ºå°‘å‰ç½®æ£€æŸ¥ï¼šä¾èµ–æ˜¯å¦å®‰è£…ï¼Ÿ**

æ¯”å¦‚ï¼š

- Maven æ˜¯å¦å­˜åœ¨ï¼Ÿ
- Node.js / npm / pnpm æ˜¯å¦å­˜åœ¨ï¼Ÿ
- Java ç‰ˆæœ¬æ˜¯å¦æ»¡è¶³ï¼Ÿ


âœ… å»ºè®®æ·»åŠ ç¯å¢ƒæ£€æŸ¥å‡½æ•°

```Bash showLineNumbers=true
check_command() {
    if ! command -v "$1" &> /dev/null; then
        log "é”™è¯¯: ç¼ºå°‘å¿…è¦å‘½ä»¤ '$1'"
        exit 1
    fi
}

check_command mvn
check_command node
check_command npm
```

#### ğŸ”§ 7. **`crontab`** **å†™å…¥æ–¹å¼ä¸å¤Ÿå®‰å…¨**

```Bash showLineNumbers=true
(crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -
```

è¿™ç§æ–¹å¼å¯èƒ½å¼•å…¥é‡å¤ä»»åŠ¡ï¼ˆè™½ç„¶ç”¨äº† `grep` åˆ¤æ–­ï¼Œä½†å­˜åœ¨ç«æ€æ¡ä»¶ï¼‰ã€‚

âœ… æ›´å®‰å…¨åšæ³•ï¼šä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ + å»é‡

```Bash showLineNumbers=true
temp_crontab=$(mktemp)
(crontab -l 2>/dev/null | grep -v "auto-deploy.sh"; echo "$CRON_JOB") > "$temp_crontab"
crontab "$temp_crontab"
rm -f "$temp_crontab"
```

#### ğŸ”§ 8. **ç¼ºå°‘éƒ¨ç½²ç»“æœå½’æ¡£æˆ–è½¯é“¾æœ€æ–°æ—¥å¿—**

å»ºè®®åˆ›å»ºä¸€ä¸ªè½¯é“¾æŒ‡å‘æœ€æ–°çš„æ—¥å¿—ï¼š

```Bash showLineNumbers=true
ln -sf "$(basename "$LOG_FILE")" "$LOG_DIR/latest_${DEPLOY_SCOPE}.log"
```

æ–¹ä¾¿å¿«é€ŸæŸ¥çœ‹æœ€è¿‘ä¸€æ¬¡æ—¥å¿—ã€‚

#### ğŸ”§ 9. **`DEPLOY_ENV`** **é»˜è®¤å€¼åº”ä»å˜é‡å–**

```Bash showLineNumbers=true
case "${DEPLOY_ENV:-dev}" in
```

âœ… æ­£ç¡®ï¼ä½ å·²ç»åšäº†é»˜è®¤å€¼å¤„ç†ï¼Œå¾ˆå¥½ã€‚

#### ğŸ”§ 10. **`console_log`** **è¾“å‡ºæœªé‡å®šå‘ï¼Œå¯èƒ½å¹²æ‰°æ—¥å¿—è§£æ**

è™½ç„¶ä¸å½±å“åŠŸèƒ½ï¼Œä½†å¦‚æœæœ‰äººç”¨è„šæœ¬è§£ææ—¥å¿—ï¼Œå½©è‰²å­—ç¬¦ï¼ˆ`\033[...`ï¼‰ä¼šé€ æˆå¹²æ‰°ã€‚

âœ… å»ºè®®ï¼šæ ¹æ®æ˜¯å¦æ˜¯ç»ˆç«¯å†³å®šæ˜¯å¦å¯ç”¨é¢œè‰²

```Bash showLineNumbers=true
if [ -t 1 ]; then
    USE_COLOR=true
else
    USE_COLOR=false
fi

console_log() {
    if [ "$USE_COLOR" = true ]; then
        echo -e "$1"
    else
        echo -e "$1" | sed 's/\x1b\[[0-9;]*m//g'  # å»é™¤ ANSI é¢œè‰²
    fi
}
```

#### âœ… æ€»ç»“è¯„åˆ†ï¼ˆæ»¡åˆ†10åˆ†ï¼‰

| ç»´åº¦           | è¯„åˆ†        | è¯´æ˜                         |
| -------------- | ----------- | ---------------------------- |
| **ç»“æ„æ¸…æ™°åº¦** | â­â­â­â­â­ 10/10 | æ¨¡å—åˆ†æ˜ï¼Œé€»è¾‘æµç•…           |
| **é”™è¯¯å¤„ç†**   | â­â­â­â­â­ 9/10  | å‡ ä¹å…¨è¦†ç›–ï¼Œä»…ç¼ºè·¯å¾„æ¢å¤     |
| **å®‰å…¨æ€§**     | â­â­â­â­â˜† 9/10  | é¿å… `source`ï¼Œæƒé™æ£€æŸ¥åˆ°ä½  |
| **å¯ç»´æŠ¤æ€§**   | â­â­â­â­â˜† 8/10  | å¯è¯»æ€§å¼ºï¼Œç¨åŠ æ³¨é‡Šæ›´ä½³       |
| **å¯æ‰©å±•æ€§**   | â­â­â­â­â˜† 8/10  | æ”¯æŒå¤šç¯å¢ƒ/å¤šèŒƒå›´ï¼Œæ˜“äºæ‰©å±•  |
| **ç”¨æˆ·ä½“éªŒ**   | â­â­â­â­â­ 10/10 | å½©è‰²æç¤ºã€é¢„ä¼°æ—¶é—´ã€æ—¥å¿—æŒ‡å¼• |
| **å¥å£®æ€§**     | â­â­â­â­â˜† 9/10  | è€ƒè™‘å¹¶å‘ã€é”ã€æƒé™ã€æ³¨å…¥ç­‰   |

> **ç»¼åˆè¯„åˆ†ï¼š9.2 / 10**

#### âœ… æœ€ç»ˆå»ºè®®ï¼ˆè¡ŒåŠ¨æ¸…å•ï¼‰

1. âœ… ä½¿ç”¨ `pushd/popd` æ›¿ä»£ `cd`ï¼Œç¡®ä¿è·¯å¾„å®‰å…¨ã€‚
2. âœ… æ—¥å¿—æ–‡ä»¶ååŠ å…¥ PID æˆ–æ¯«ç§’ï¼Œé¿å…å†²çªã€‚
3. âœ… æ£€æŸ¥ `send-notify.sh` æ˜¯å¦å­˜åœ¨ä¸”å¯æ‰§è¡Œã€‚
4. âœ… æ·»åŠ  `check_command` æ£€æŸ¥å…³é”®ä¾èµ–ï¼ˆmvnã€node ç­‰ï¼‰ã€‚
5. âœ… æ·»åŠ  Git æ‹‰å–æœ€æ–°ä»£ç é€»è¾‘ï¼ˆå¯é…ç½®æ˜¯å¦å¼€å¯ï¼‰ã€‚
6. âœ… åˆ›å»º `latest.log` è½¯é“¾æ–¹ä¾¿æŸ¥çœ‹ã€‚
7. âœ… ä¼˜åŒ– crontab å†™å…¥æ–¹å¼ï¼Œé¿å…é‡å¤ã€‚
8. âœ… ï¼ˆå¯é€‰ï¼‰æ ¹æ®ç»ˆç«¯åˆ¤æ–­æ˜¯å¦å¯ç”¨é¢œè‰²è¾“å‡ºã€‚
   1. 

### ğŸ‰ ç»“è®º

è¿™æ˜¯ä¸€æ®µ**é«˜è´¨é‡ã€ç”Ÿäº§å¯ç”¨çš„è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬**ï¼Œè¿œè¶…å¤§å¤šæ•°å›¢é˜Ÿçš„è¿ç»´è„šæœ¬æ°´å¹³ã€‚ç¨ä½œä¼˜åŒ–åï¼Œå®Œå…¨å¯ä»¥ä½œä¸º CI/CD æµæ°´çº¿ä¸­çš„â€œæ‰‹åŠ¨è§¦å‘éƒ¨ç½²â€æˆ–â€œå®šæ—¶éƒ¨ç½²â€æ ¸å¿ƒç»„ä»¶ã€‚

## ä¸‰ã€deploy-config.conf é…ç½®æ–‡ä»¶

```Shell showLineNumbers=true
# æ˜¯å¦æ‰§è¡Œéƒ¨ç½², é»˜è®¤æ­£å¸¸5ç‚¹å®šæ—¶æ‰§è¡Œ (true/false)
RUN_DEPLOY=true

# éƒ¨ç½²ç¯å¢ƒï¼Œé»˜è®¤æµ‹è¯•æœåŠ¡å™¨ (dev=æµ‹è¯•æœåŠ¡å™¨ / prod=æ­£å¼æœåŠ¡å™¨)
DEPLOY_ENV=dev

# éƒ¨ç½²èŒƒå›´:
#   all   = éƒ¨ç½²åç«¯ + å‰ç«¯
#   backend = åªéƒ¨ç½²åç«¯ (deploy-project.sh)
#   frontend = åªéƒ¨ç½²å‰ç«¯ (copyweb.sh)
DEPLOY_SCOPE=backend
```

## å››ã€check-log.sh æŸ¥çœ‹æ—¥å¿—è„šæœ¬

```Bash showLineNumbers=true
#!/bin/bash
# æ—¥å¿—ç®¡ç†å·¥å…· check-log.sh
# åŠŸèƒ½ï¼šäº¤äº’å¼æŸ¥çœ‹ã€åˆ é™¤ã€æ¸…ç†éƒ¨ç½²æ—¥å¿—

LOG_DIR="/home/build/deploy-logs"
mkdir -p "$LOG_DIR"   # ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨

while true; do
    clear
    echo "============================"
    echo "     éƒ¨ç½²æ—¥å¿—ç®¡ç†å·¥å…·"
    echo "  æ—¥å¿—ç›®å½•: $LOG_DIR"
    echo "============================"
    echo "1) åˆ—å‡ºæ‰€æœ‰æ—¥å¿—æ–‡ä»¶"
    echo "2) æŸ¥çœ‹æœ€æ–°æ—¥å¿—"
    echo "3) é€‰æ‹©æ—¥å¿—æ–‡ä»¶æŸ¥çœ‹"
    echo "4) åˆ é™¤æŒ‡å®šæ—¥å¿—æ–‡ä»¶"
    echo "5) æ¸…ç©ºæ‰€æœ‰æ—¥å¿—"
    echo "6) é€€å‡º"
    echo "============================"
    read -p "è¯·é€‰æ‹©æ“ä½œ [1-6]: " choice

    case $choice in
        1)
            echo "[æ—¥å¿—æ–‡ä»¶åˆ—è¡¨]"
            if [ "$(ls -A $LOG_DIR)" ]; then
                ls -lh "$LOG_DIR"
            else
                echo "æ—¥å¿—ç›®å½•ä¸ºç©ºã€‚"
            fi
            read -p "æŒ‰å›è½¦é”®è¿”å›èœå•..."
            ;;
        2)
            latest_log=$(ls -t "$LOG_DIR" 2>/dev/null | head -n 1)
            if [ -z "$latest_log" ]; then
                echo "æ²¡æœ‰æ‰¾åˆ°æ—¥å¿—æ–‡ä»¶ã€‚"
                read -p "æŒ‰å›è½¦é”®è¿”å›èœå•..."
            else
                echo "æ­£åœ¨æŸ¥çœ‹æœ€æ–°æ—¥å¿—: $latest_log"
                echo "--------------------------------"
                echo "[æç¤º] less ä½¿ç”¨è¯´æ˜ï¼šç©ºæ ¼ç¿»é¡µï¼Œb ä¸Šç¿»ï¼Œ/æœç´¢ï¼Œn ä¸‹ä¸€ä¸ªï¼Œq é€€å‡º"
                read -p "æŒ‰å›è½¦å¼€å§‹æŸ¥çœ‹..."
                less "$LOG_DIR/$latest_log"
            fi
            ;;
        3)
            echo "[é€‰æ‹©æ—¥å¿—æ–‡ä»¶æŸ¥çœ‹]"
            logs=("$LOG_DIR"/*)
            if [ ! -e "${logs[0]}" ]; then
                echo "æ²¡æœ‰æ—¥å¿—æ–‡ä»¶ã€‚"
                read -p "æŒ‰å›è½¦é”®è¿”å›èœå•..."
                continue
            fi
            echo "0) è¿”å›èœå•"
            select logfile in "${logs[@]}"; do
                if [ "$REPLY" == "0" ]; then
                    break
                elif [ -n "$logfile" ] && [ -f "$logfile" ]; then
                    echo "[æç¤º] less ä½¿ç”¨è¯´æ˜ï¼šç©ºæ ¼ç¿»é¡µï¼Œb ä¸Šç¿»ï¼Œ/æœç´¢ï¼Œn ä¸‹ä¸€ä¸ªï¼Œq é€€å‡º"
                    read -p "æŒ‰å›è½¦å¼€å§‹æŸ¥çœ‹..."
                    less "$logfile"
                    break
                else
                    echo "æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡è¯•ã€‚"
                fi
            done
            ;;
        4)
            echo "[é€‰æ‹©æ—¥å¿—æ–‡ä»¶åˆ é™¤]"
            logs=("$LOG_DIR"/*)
            if [ ! -e "${logs[0]}" ]; then
                echo "æ²¡æœ‰æ—¥å¿—æ–‡ä»¶ã€‚"
                read -p "æŒ‰å›è½¦é”®è¿”å›èœå•..."
                continue
            fi
            echo "0) è¿”å›èœå•"
            select logfile in "${logs[@]}"; do
                if [ "$REPLY" == "0" ]; then
                    break
                elif [ -n "$logfile" ] && [ -f "$logfile" ]; then
                    read -p "ç¡®å®šè¦åˆ é™¤ $logfile å—ï¼Ÿ(y/n): " confirm
                    if [[ $confirm == "y" ]]; then
                        rm -f "$logfile"
                        echo "å·²åˆ é™¤ $logfile"
                    else
                        echo "æ“ä½œå–æ¶ˆ"
                    fi
                    read -p "æŒ‰å›è½¦é”®è¿”å›èœå•..."
                    break
                else
                    echo "æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡è¯•ã€‚"
                fi
            done
            ;;
        5)
            read -p "ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿ(y/n): " confirm
            if [[ $confirm == "y" ]]; then
                rm -f "$LOG_DIR"/*
                echo "æ‰€æœ‰æ—¥å¿—å·²æ¸…ç©ºã€‚"
            else
                echo "æ“ä½œå–æ¶ˆã€‚"
            fi
            sleep 2
            ;;
        6)
            echo "é€€å‡ºæ—¥å¿—ç®¡ç†å·¥å…·ã€‚"
            exit 0
            ;;
        *)
            echo "æ— æ•ˆé€‰é¡¹ï¼Œè¯·è¾“å…¥ 1-6ã€‚"
            sleep 2
            ;;
    esac
done
```

## äº”ã€send-notify.sh é’‰é’‰é€šçŸ¥è„šæœ¬

```Bash showLineNumbers=true
#!/usr/bin/env bash

# ========================
# é’‰é’‰é€šçŸ¥è„šæœ¬ï¼ˆè‡ªåŠ¨éƒ¨ç½²ä¸“ç”¨ï¼‰
# ========================

# ğŸ” é’‰é’‰æœºå™¨äºº Webhookï¼ˆè¯·å‹¿æ³„éœ²ï¼‰
WEBHOOK_URL="https://oapi.dingtalk.com/robot/send?access_token=XXXXXXSX"

# å‚æ•°
TITLE="${1:-éƒ¨ç½²é€šçŸ¥}"
CONTENT="${2:-çŠ¶æ€æœªçŸ¥}"
STATUS="${3:-info}"

# è®¾ç½®å›¾æ ‡
case "$STATUS" in
    success)
        ICON="âœ…"
        ;;
    error)
        ICON="âŒ"
        ;;
    *)
        ICON="â„¹ï¸"
        ;;
esac

# æ„é€  JSONï¼ˆå…³é”®ï¼šæ·»åŠ å…³é”®è¯ + æ­£ç¡®è½¬ä¹‰ï¼‰
PAYLOAD="{
  \"msgtype\": \"markdown\",
  \"markdown\": {
    \"title\": \"$TITLE\",
    \"text\": \"å…³é”®è¯\n\n$ICON $TITLE\\n\\n> $CONTENT\"
  },
  \"at\": {
    \"isAtAll\": false
  }
}"

# å‘é€è¯·æ±‚ï¼ˆå¿½ç•¥é”™è¯¯ï¼Œé¿å…å½±å“ä¸»æµç¨‹ï¼‰
curl -s -X POST \
     -H "Content-Type: application/json" \
     -d "$PAYLOAD" \
     "$WEBHOOK_URL" >/dev/null 2>&1 || true
```